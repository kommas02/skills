name: Validate Skills

on:
  pull_request:
    paths:
      - 'skills/**'
  push:
    branches:
      - main
    paths:
      - 'skills/**'

permissions:
  contents: read

jobs:
  validate-yaml:
    name: Validate YAML Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate YAML files
        run: |
          for yaml in $(find skills -name "*.yaml" -o -name "*.yml" 2>/dev/null); do
            python3 -c "import yaml; yaml.safe_load(open('$yaml'))" || { echo "Invalid YAML: $yaml"; exit 1; }
          done
          echo "All YAML files are valid"

  validate-python:
    name: Validate Python Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Python files
        run: |
          for py in $(find skills -name "*.py" 2>/dev/null); do
            python3 -m py_compile "$py" || { echo "Invalid Python: $py"; exit 1; }
          done
          echo "All Python files are valid"

  validate-skill-md:
    name: Validate SKILL.md Frontmatter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate SKILL.md frontmatter
        run: |
          find skills -name "SKILL.md" | while read skill_md; do
            if ! grep -q "^---$" "$skill_md"; then
              echo "ERROR: $skill_md missing frontmatter"
              exit 1
            fi
            
            content=$(sed -n '/^---$/,/^---$/p' "$skill_md" | tail -n +2 | head -n -1)
            
            if ! echo "$content" | grep -q "^name:"; then
              echo "ERROR: $skill_md missing 'name' in frontmatter"
              exit 1
            fi
            
            if ! echo "$content" | grep -q "^description:"; then
              echo "ERROR: $skill_md missing 'description' in frontmatter"
              exit 1
            fi
            
            echo "OK: $skill_md"
          done
          echo "All SKILL.md files have valid frontmatter"

  validate-markdown-links:
    name: Validate Markdown Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check markdown links
        run: |
          find skills -name "*.md" | while read md; do
            while IFS= read -r line; do
              if echo "$line" | grep -qE '\[.*\]\((https?://[^)]+)\)'; then
                url=$(echo "$line" | grep -oE '\[.*\]\((https?://[^)]+)\)' | sed 's/.*(\(https\?:\/\/[^)]*\)).*/\1/')
                if ! curl -s --head --fail --max-time 10 "$url" > /dev/null 2>&1; then
                  echo "WARNING: Broken link in $md: $url"
                fi
              fi
            done < "$md"
          done || true
          echo "Link validation complete"

  validate-evaluations:
    name: Validate Evaluation Cases
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check evaluation presence
        run: |
          missing=0
          for skill_dir in skills/.curated/*/; do
            skill_name=$(basename "$skill_dir")
            eval_dir="$skill_dir evaluation"
            
            if [ -d "$eval_dir" ]; then
              count=$(find "$eval_dir" -name "*.json" 2>/dev/null | wc -l)
              if [ "$count" -lt 2 ]; then
                echo "WARNING: $skill_name has only $count evaluation(s), need minimum 2"
              else
                echo "OK: $skill_name has $count evaluations"
              fi
            else
              echo "WARNING: $skill_name missing evaluation directory"
              missing=$((missing + 1))
            fi
          done
          
          if [ "$missing" -gt 0 ]; then
            echo "Note: $missing skills missing evaluation directory"
          fi
          echo "Evaluation check complete"
